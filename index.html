<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>פוטושופאי - עורך תמונות AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        /* Basic styles to respect Telegram's theme */
        :root {
            --tg-theme-bg-color: #212121;
            --tg-theme-text-color: #ffffff;
            --tg-theme-hint-color: #aaaaaa;
            --tg-theme-link-color: #8774e1;
            --tg-theme-button-color: #8774e1;
            --tg-theme-button-text-color: #ffffff;
            --tg-theme-secondary-bg-color: #181818;
        }

        body {
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 1rem;
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .card {
            background-color: var(--tg-theme-secondary-bg-color);
            border-radius: 0.75rem;
            padding: 1.5rem;
        }
        
        /* Loading Spinner */
        .loader {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 5px solid var(--tg-theme-hint-color);
            border-top: 5px solid var(--tg-theme-button-color);
            animation: spin 1s linear infinite;
        }
        
        .suggestion-loader {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid var(--tg-theme-hint-color);
            border-top: 2px solid var(--tg-theme-button-color);
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Before/After Image container */
        .image-container {
            position: relative;
            overflow: hidden;
            border-radius: 0.5rem;
        }
        .image-container img {
            max-width: 100%;
            height: auto;
            display: block;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

    <div id="app" class="w-full max-w-lg mx-auto">

        <!-- 1. Initial Upload Screen -->
        <div id="upload-screen" class="card text-center">
            <h1 class="text-2xl font-bold mb-2">פוטושופאי AI</h1>
            <p class="text-lg text-gray-400 mb-6">עוזר העריכה האישי שלך</p>
            <div class="border-2 border-dashed border-gray-600 rounded-lg p-8 cursor-pointer hover:bg-gray-800 transition-colors" onclick="document.getElementById('image-input').click()">
                <i class="fas fa-cloud-upload-alt text-5xl text-gray-500 mb-4"></i>
                <p class="font-semibold">העלה/י תמונה כדי להתחיל</p>
                <p class="text-sm text-gray-500">לחץ/י כאן לבחירת קובץ</p>
            </div>
            <input type="file" id="image-input" accept="image/*" class="hidden">
        </div>

        <!-- 2. Editing Screen -->
        <div id="edit-screen" class="hidden">
            <div class="card mb-4">
                <img id="image-preview" src="" alt="Image Preview" class="rounded-lg w-full max-h-[40vh] object-contain">
            </div>
            <div class="card">
                <div class="flex justify-between items-center mb-2">
                     <label for="prompt-input" class="block text-lg font-medium">מה תרצה/י לשנות בתמונה?</label>
                     <button id="suggestion-btn" class="text-sm bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-3 rounded-lg transition flex items-center gap-2">
                        <span id="suggestion-btn-text">✨ הצע לי רעיונות</span>
                        <div id="suggestion-loader" class="suggestion-loader hidden"></div>
                     </button>
                </div>
                <textarea id="prompt-input" rows="3" class="w-full p-2 rounded-md bg-gray-800 border border-gray-600 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition" placeholder="לדוגמה: הסר את האדם ברקע..."></textarea>
                <div id="suggestions-container" class="mt-3 flex flex-wrap gap-2"></div>
            </div>
        </div>
        
        <!-- 3. Loading Screen -->
        <div id="loading-screen" class="hidden card text-center p-8">
            <div class="loader mx-auto mb-6"></div>
            <p class="text-lg font-semibold animate-pulse">יוצר קסם... נא להמתין</p>
            <p class="text-sm text-gray-400 mt-2">הבינה המלאכותית עובדת על התמונה שלך</p>
        </div>

        <!-- 4. Result Screen -->
        <div id="result-screen" class="hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div class="card text-center">
                    <h2 class="text-xl font-bold mb-2">לפני</h2>
                    <div class="image-container">
                        <img id="before-image" src="" alt="Original Image">
                    </div>
                </div>
                <div class="card text-center">
                    <h2 class="text-xl font-bold mb-2">אחרי</h2>
                     <div class="image-container">
                        <img id="after-image" src="" alt="Edited Image">
                    </div>
                </div>
            </div>
             <div class="grid grid-cols-2 lg:grid-cols-3 gap-2">
                <button id="download-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition"><i class="fas fa-download mr-2"></i>הורדה</button>
                <button id="share-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition"><i class="fas fa-share-alt mr-2"></i>שיתוף</button>
                <button id="new-edit-btn" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-lg transition col-span-2 lg:col-span-1"><i class="fas fa-pencil-alt mr-2"></i>עריכה חדשה</button>
            </div>
        </div>
    </div>

    <script type="module">
        const tg = window.Telegram.WebApp;

        // --- CONFIGURATION ---
        // IMPORTANT: In a production app, you MUST NOT expose your API key. 
        // Move all API calls to a secure backend server.
      //  const GOOGLE_API_KEY = ""; // Leave this empty, it will be handled by the environment.
        const IMAGE_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${GOOGLE_API_KEY}`;
   const TEXT_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GOOGLE_API_KEY}`;
        
        // --- DOM ELEMENTS ---
        const screens = {
            upload: document.getElementById('upload-screen'),
            edit: document.getElementById('edit-screen'),
            loading: document.getElementById('loading-screen'),
            result: document.getElementById('result-screen'),
        };
        const imageInput = document.getElementById('image-input');
        const imagePreview = document.getElementById('image-preview');
        const promptInput = document.getElementById('prompt-input');
        const suggestionBtn = document.getElementById('suggestion-btn');
        const suggestionBtnText = document.getElementById('suggestion-btn-text');
        const suggestionLoader = document.getElementById('suggestion-loader');
        const suggestionsContainer = document.getElementById('suggestions-container');
        const beforeImage = document.getElementById('before-image');
        const afterImage = document.getElementById('after-image');
        const downloadBtn = document.getElementById('download-btn');
        const shareBtn = document.getElementById('share-btn');
        const newEditBtn = document.getElementById('new-edit-btn');
        
        let originalImageBase64 = null;
        let editedImageBase64 = null;

        // --- FUNCTIONS ---

        function showScreen(screenName) {
            Object.values(screens).forEach(screen => screen.classList.add('hidden'));
            if (screens[screenName]) {
                screens[screenName].classList.remove('hidden');
            }
        }

        function base64ToBlob(base64, mimeType) {
            const byteCharacters = atob(base64);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            return new Blob([byteArray], { type: mimeType });
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }
        
        async function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                originalImageBase64 = await fileToBase64(file);
                imagePreview.src = `data:image/jpeg;base64,${originalImageBase64}`;
                beforeImage.src = `data:image/jpeg;base64,${originalImageBase64}`;
                
                showScreen('edit');
                suggestionsContainer.innerHTML = ''; // Clear old suggestions
                tg.MainButton.setText("צור קסם");
                tg.MainButton.show();
                tg.HapticFeedback.impactOccurred('light');
            } catch (error) {
                console.error("Error handling image upload:", error);
                tg.showAlert('אירעה שגיאה בעיבוד התמונה. נסה/י קובץ אחר.');
                showScreen('upload');
                tg.MainButton.hide();
            }
        }

        async function processImageEdit() {
            const userPrompt = promptInput.value;
            if (!userPrompt.trim()) {
                tg.showAlert('נא להזין בקשה לעריכה.');
                return;
            }

            showScreen('loading');
            tg.MainButton.hide();
            tg.HapticFeedback.notificationOccurred('warning');

            try {
                const engineeredPrompt = `${userPrompt}. Make the edit look photorealistic.`;
                const response = await callImageApi(originalImageBase64, engineeredPrompt);
                
                const generatedPart = response?.candidates?.[0]?.content?.parts?.find(p => p.inlineData);
                if (!generatedPart) {
                    throw new Error("לא התקבלה תמונה מה-API. ייתכן והבקשה נדחתה עקב מדיניות בטיחות.");
                }

                editedImageBase64 = generatedPart.inlineData.data;
                afterImage.src = `data:${generatedPart.inlineData.mimeType};base64,${editedImageBase64}`;

                showScreen('result');
                tg.HapticFeedback.notificationOccurred('success');

            } catch (error) {
                console.error("API Error:", error);
                tg.showAlert(`אירעה שגיאה: ${error.message}`);
                showScreen('edit'); // Go back to edit screen on error
                tg.MainButton.show();
            }
        }

        async function getPromptSuggestions() {
            if (!originalImageBase64) {
                tg.showAlert('נא להעלות תמונה תחילה.');
                return;
            }
            
            suggestionBtn.disabled = true;
            suggestionBtnText.classList.add('hidden');
            suggestionLoader.classList.remove('hidden');
            suggestionsContainer.innerHTML = ''; // Clear previous suggestions
            tg.HapticFeedback.impactOccurred('light');

            try {
                const prompt = `Analyze this image and provide 3 creative and concise photo editing suggestions in Hebrew. The suggestions should be phrased as commands an expert photo editor would use. The tone should be inspiring. Return the response as a valid JSON object with a single key "suggestions" which is an array of strings. For example: {"suggestions": ["הפוך את השמיים לדרמטיים וסוערים", "הוסף אפקט של ציור שמן", "שנה את צבע החולצה שלי לכחול"]}`;
                const response = await callTextApi(originalImageBase64, prompt);

                const textResponse = response?.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!textResponse) {
                     throw new Error("לא התקבלו הצעות מה-API.");
                }

                // Clean the response from markdown and parse it
                const jsonString = textResponse.replace(/```json|```/g, '').trim();
                const parsed = JSON.parse(jsonString);
                
                if (parsed.suggestions && Array.isArray(parsed.suggestions)) {
                    parsed.suggestions.forEach(suggestion => {
                        const button = document.createElement('button');
                        button.textContent = suggestion;
                        button.className = "bg-gray-700 hover:bg-purple-600 text-white text-sm font-semibold py-1 px-3 rounded-full transition";
                        button.onclick = () => {
                            promptInput.value = suggestion;
                            suggestionsContainer.innerHTML = ''; // Clear suggestions after selection
                            tg.HapticFeedback.impactOccurred('light');
                        };
                        suggestionsContainer.appendChild(button);
                    });
                } else {
                    throw new Error("פורמט ההצעות שהתקבל אינו תקין.");
                }

            } catch (error) {
                console.error("Suggestion API Error:", error);
                tg.showAlert(`שגיאה בקבלת הצעות: ${error.message}`);
            } finally {
                suggestionBtn.disabled = false;
                suggestionBtnText.classList.remove('hidden');
                suggestionLoader.classList.add('hidden');
            }
        }
        
        async function callApiWithExponentialBackoff(apiUrl, payload, maxRetries = 3) {
            let attempt = 0;
            while (attempt < maxRetries) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429 || response.status >= 500) { // Throttling or server error
                        throw new Error(`Server error with status ${response.status}`);
                    }
                    
                    if (!response.ok) {
                        const errorBody = await response.json();
                        console.error("Google API Error Response:", errorBody);
                        throw new Error(`שגיאת שרת (${response.status}): ${errorBody.error?.message || 'Unknown error'}`);
                    }

                    return response.json();

                } catch (error) {
                    attempt++;
                    if (attempt >= maxRetries) {
                        throw error;
                    }
                    const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }
        
        async function callImageApi(imageBase64, prompt) {
            const payload = { imageBase64, prompt };
            return callApiWithExponentialBackoff(IMAGE_API_URL, payload);
        }

        async function callTextApi(imageBase64, prompt) {
            const payload = { imageBase64 };
            return callApiWithExponentialBackoff(TEXT_API_URL, payload);
        }

        // --- EVENT LISTENERS ---
        imageInput.addEventListener('change', handleImageUpload);
        suggestionBtn.addEventListener('click', getPromptSuggestions);
        tg.onEvent('mainButtonClicked', processImageEdit);
        
        downloadBtn.addEventListener('click', () => {
            if (!editedImageBase64) return;
            const blob = base64ToBlob(editedImageBase64, 'image/png');
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'edited_image_by_photoshopai.png';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            tg.HapticFeedback.impactOccurred('light');
        });
        
        shareBtn.addEventListener('click', () => {
            tg.shareMessage({
               text: "נוצרה באמצעות בוט הפוטושופאי! נסו גם אתם.",
               url: "t.me/YourBotUsername" // TODO: Replace with your bot's username link
            });
            tg.HapticFeedback.impactOccurred('light');
        });

        newEditBtn.addEventListener('click', () => {
            // Reset state
            originalImageBase64 = null;
            editedImageBase64 = null;
            imageInput.value = '';
            promptInput.value = '';
            
            showScreen('upload');
            tg.MainButton.hide();
            tg.HapticFeedback.impactOccurred('medium');
        });

        // --- INITIALIZATION ---
        function init() {
            tg.ready();
            tg.expand();
            
            tg.MainButton.setParams({ text: "צור קסם", color: '#8774e1', text_color: '#ffffff' });
            tg.MainButton.hide();

            document.body.style.backgroundColor = tg.themeParams.bg_color || '#212121';
            document.body.style.color = tg.themeParams.text_color || '#ffffff';
            
            showScreen('upload');
        }

        init();
    </script>
</body>
</html>

